{% extends "base.html" %}

{% block title %}Login - Founders Management{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
        <div class="text-center">
            <div class="mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-telegram-blue">
                <i data-feather="shield" class="h-6 w-6 text-white"></i>
            </div>
            <h2 class="mt-6 text-3xl font-extrabold">Founders Management</h2>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                Gold Purchase & Sales Management System
            </p>
        </div>
        
        <div class="bg-white dark:bg-gray-800 py-8 px-6 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700">
            <div id="login-status" class="text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-telegram-blue mx-auto mb-4"></div>
                <p class="text-gray-600 dark:text-gray-400">Connecting to Telegram...</p>
            </div>
            
            <div id="login-error" class="hidden text-center">
                <div class="bg-red-50 dark:bg-red-900/50 border border-red-200 dark:border-red-700 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-center">
                        <i data-feather="alert-circle" class="h-5 w-5 text-red-600 dark:text-red-400 mr-2"></i>
                        <span class="text-red-800 dark:text-red-200">
                            This application must be opened through Telegram
                        </span>
                    </div>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    Please access this app through the Telegram WebApp interface
                </p>
            </div>
            
            <div id="access-denied" class="hidden text-center">
                <div class="bg-yellow-50 dark:bg-yellow-900/50 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-center">
                        <i data-feather="lock" class="h-5 w-5 text-yellow-600 dark:text-yellow-400 mr-2"></i>
                        <span class="text-yellow-800 dark:text-yellow-200">
                            Access Denied
                        </span>
                    </div>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    You are not authorized to access this application. Please contact the administrator.
                </p>
            </div>
        </div>
        
        <div class="text-center text-xs text-gray-500 dark:text-gray-400">
            <p>Secure authentication via Telegram WebApp</p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Enhanced cross-platform authentication
    async function performAuthentication() {
        try {
            // Wait for Telegram WebApp to initialize
            if (!window.telegramWebApp) {
                throw new Error('Telegram WebApp not initialized');
            }
            
            const webApp = window.telegramWebApp;
            
            // Show debug info in console
            console.log('Debug info:', webApp.getDebugInfo());
            
            // Check if authentication is available
            if (!webApp.isAuthenticationAvailable()) {
                throw new Error('Authentication data not available');
            }
            
            // Check cached authentication first
            try {
                const statusResponse = await fetch('/auth/status');
                const statusData = await statusResponse.json();
                
                if (statusData.authenticated && statusData.telegram_id === webApp.user.id) {
                    console.log('Using cached authentication session');
                    window.location.href = '/dashboard';
                    return;
                }
            } catch (e) {
                console.log('No cached session available, proceeding with fresh auth');
            }
            
            // Perform authentication with platform support
            const authResult = await webApp.authenticate();
            
            if (authResult.success) {
                if (authResult.cached) {
                    console.log('Fast authentication using session cache');
                } else {
                    console.log('Full authentication completed for platform:', webApp.platform.platform);
                }
                window.location.href = authResult.redirect;
            } else if (authResult.error && authResult.error.includes('Access denied')) {
                document.getElementById('login-status').classList.add('hidden');
                document.getElementById('access-denied').classList.remove('hidden');
            } else {
                throw new Error(authResult.error || 'Authentication failed');
            }
            
        } catch (error) {
            console.error('Authentication error:', error);
            
            // Show detailed error info for debugging
            if (window.telegramWebApp) {
                console.error('Telegram WebApp debug info:', window.telegramWebApp.getDebugInfo());
            }
            
            document.getElementById('login-status').classList.add('hidden');
            document.getElementById('login-error').classList.remove('hidden');
            
            // Add platform-specific error message
            const errorElement = document.querySelector('#login-error span');
            if (errorElement && window.telegramWebApp) {
                const platform = window.telegramWebApp.platform;
                if (platform.isDesktop) {
                    errorElement.textContent = 'Desktop Telegram authentication issue. Please try refreshing or reopening the app.';
                } else if (platform.isMobile) {
                    errorElement.textContent = 'Mobile Telegram authentication issue. Please ensure you opened this from Telegram app.';
                } else {
                    errorElement.textContent = 'Telegram authentication failed. Please open this app through Telegram.';
                }
            }
        }
    }
    
    // Check if Telegram WebApp is available
    if (window.Telegram && window.Telegram.WebApp) {
        // Wait a moment for our enhanced WebApp class to initialize
        setTimeout(() => {
            performAuthentication();
        }, 500);
    } else {
        // Not in Telegram WebApp environment
        setTimeout(() => {
            document.getElementById('login-status').classList.add('hidden');
            document.getElementById('login-error').classList.remove('hidden');
        }, 2000);
    }
});
</script>
{% endblock %}
